<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon" sizes="180x180" href="asset/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="asset/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="asset/favicon-16x16.png">
    <link rel="manifest" href="asset/site.webmanifest">
    <link rel="mask-icon" href="asset/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#b91d47">
    <meta name="theme-color" content="#ffffff">

    <title>Watch List - Oxlâ˜°yrd</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css">

    <script src="https://widgets.coingecko.com/coingecko-coin-list-widget.js"></script>
    <style>
        .small-text {
            font-size: small;
            overflow-wrap: break-word
        }

        .active {
            background-color: #ddd;
        }

        .w-section {
            /* padding: 10px; */
            min-width: 300px;
            padding-bottom: 20px;
        }
    </style>
    <script>
        // https://benborgers.com/posts/google-sheets-json
        var gs_watch_url = "https://opensheet.elk.sh/1mejGkcnF-f_qE4kw47FABEIkv8SZ4QgXAlciUOURYMo/Watch";

        var listtype = "M"; // multiple list
        var filter = "-"; // all sections
        var refreshinterval = 30; // default: 30 secs


        var refreshTimer;

        function _onload() {
            // event listeners
            document.getElementById("reloadbutton").addEventListener("click", () => refreshData());
            document.getElementById("toggolbutton").addEventListener("click", () => toggle());
            document.getElementById("filter").addEventListener("change", (e) => { filter = e.target.value; changeFilter() });
            document.getElementById("autorefresh").addEventListener("change", (e) => { refreshinterval = e.target.value; setupAutoRefresh() });
            // initialization
            loadSetting();
            init();
        }

        function loadSetting() {
            var s = localStorage.getItem("listtype");
            var f = localStorage.getItem("filter");
            var r = localStorage.getItem("refreshinterval");

            console.log("[localStorage] listtype", listtype, "; filter", filter, "; refreshinterval", refreshinterval);

            if (s) { listtype = s }
            if (f) { filter = f; }
            if (r) { refreshinterval = parseInt(r); }
        }

        function init() {
            resetState();
            loadList();
            setupAutoRefresh();
        }

        function resetState() {
            console.log("[resetState] listtype", listtype, "; filter", filter, "; refreshinterval", refreshinterval);

            // auto refresh
            var refreshIntervalInput = document.getElementById("autorefresh");
            var countdownDisplay = document.getElementById("countdown");

            refreshIntervalInput.value = refreshinterval;
            countdownDisplay.textContent = refreshinterval;

            // filter (for multiple list)
            var filterControl = document.getElementById("filtergrp");

            // list type (single/multiple)
            var label = "";
            if (listtype == "S") {
                label = "Multiple List";
                filterControl.style.display = "none";
            }
            else {
                label = "Single List";
                filterControl.style.display = "inline";
            }
            document.getElementById("toggolbutton").textContent = label;
            localStorage.setItem("listtype", listtype);
        }

        function loadList() {
            console.log("loadList...");
            listtype == "M" ? loadWidget(loadMultipleList) : loadWidget(loadSingleList);
        }

        function toggle() {
            listtype == "M" ? listtype = "S" : listtype = "M";
            init();
        }

        // refresh data
        function refreshData() {
            console.log("..... refresh data .....");
            loadList();
            setupAutoRefresh();
        }


        function setupAutoRefresh() {
            if (refreshTimer) {
                console.log("[setupAutoRefresh] clear the current refresh timer");
                clearTimeout(refreshTimer);
            }
            console.log("setupAutoRefresh");
            localStorage.setItem("refreshinterval", refreshinterval);

            (function countdown(remaining) {
                if (remaining <= 0) {
                    refreshData();
                } else {
                    document.getElementById('countdown').innerHTML = remaining;
                    refreshTimer = setTimeout(function () { countdown(remaining - 1); }, 1000);
                }
            })(refreshinterval);
        }

        function changeFilter() {
            console.log("changeFilter, current filter", filter);
            localStorage.setItem("filter", filter);
            var sections = document.getElementsByClassName("w-section");
            Array.from(sections).map((sec) => {
                sec.id == filter || filter == "-" ? sec.style.display = "block" : sec.style.display = "none"
            });
        }

        function clearELementById(id) {
            var container = document.getElementById(id);
            while (container.firstChild) {
                container.removeChild(container.lastChild);
            }
        }

        function fetchData(handler) {
            fetch(gs_watch_url)
                .then((res) => res.json())
                .then((data) => { handler(data) });
        }

        function loadWidget(handler) {
            clearELementById("container");
            fetchData(handler);
        }

        function loadSingleList(data) {
            console.log("single");
            var list = data.map(row => row.CGID);
            createWatchList(list);
        }

        function loadMultipleList(data) {
            console.log("mutiple");

            var result = data.reduce(function (map, obj) {

                var v = map[obj.Type];
                !v ? map[obj.Type] = [obj.CGID] : map[obj.Type].push(obj.CGID);
                return map;
            }, {});

            // 1. create the watch list first
            Object.keys(result).map((key) => {
                createWatchList(result[key], key)
            });

            // 2. then create the filter
            createFilterOption(Object.keys(result));
        }

        function createFilterOption(types) {
            clearELementById("filter");
            var filterControl = document.getElementById("filter");
            var o = document.createElement("option");
            o.value = "-";
            o.text = "ALL";
            filterControl.appendChild(o);

            types.map((type) => {
                var o = document.createElement("option");
                o.value = o.text = type;
                filterControl.appendChild(o);
            })
            console.log("constructed filter", filterControl.value);
            if (filter != filterControl.value) {
                filterControl.value = filter;
                console.log("set new filter", filterControl.value);
                changeFilter();
            }
        }

        function createWatchList(list, type) {
            var wrapper = document.createElement("div");
            wrapper.className = "col-sm w-section";
            if (type) wrapper.id = type;

            // example:
            //     <coingecko-coin-list-widget id="listwidget" coin-ids="bitcoin" currency="usd" locale="en">
            //     </coingecko-coin-list-widget>
            if (type) {
                var h = document.createElement("h4");
                h.textContent = type;
                wrapper.appendChild(h);
            }

            var w = document.createElement("coingecko-coin-list-widget");
            w.setAttribute("currency", "usd");
            w.setAttribute("locale", "en");
            w.setAttribute("coin-ids", list.join(","));

            wrapper.appendChild(w);

            var hole = document.getElementById("container");
            hole.appendChild(wrapper);
        }


    </script>
</head>

<body onload="_onload()">
    <header>
        <a href="index.html" class="logo"><img width="40" style="vertical-align: middle;" src="logo.png"></a>
        <a href="index.html" class="button">Home</a>
        <button class="active">Watch List</button>
    </header>

    <div class="container">
        <div class="row">
            <div class="col-sm-12 col-md-5">
                <button class="primary shadowed" id="toggolbutton">Single List</button>
                <span id="filtergrp">
                    <label for="filter">Filter</label>
                    <select id="filter"></select>
                </span>

            </div>

            <div class="col-sm-12 col-md-7">
                <div style="float: right;">
                    <label for="autorefresh">Auto Refresh (s)</label>
                    <input id="autorefresh" type="number" min="10" max="60">
                    <button id="reloadbutton"><img width="15" style="vertical-align: middle;"
                            src="https://img.icons8.com/external-kmg-design-glyph-kmg-design/32/000000/external-refresh-arrow-kmg-design-glyph-kmg-design.png" />
                        Reload (<span id="countdown"></span>)
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div class="container">
        <div class="row" id="container"></div>
    </div>
</body>

</html>