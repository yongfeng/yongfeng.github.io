<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch List - Oxlâ˜°yrd</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css">

    <script src="https://widgets.coingecko.com/coingecko-coin-list-widget.js"></script>
    <style>
        .w-hole {
            display: table-row
        }

        .w-title {
            font-size: larger;
            font-style: bold;
            vertical-align: middle;
            height: 100%;

        }

        .w-section {
            /* padding: 10px; */
            min-width: 300px;
            padding-bottom: 20px;
        }
    </style>
    <script>
        // https://benborgers.com/posts/google-sheets-json
        var gs_watch_url = "https://opensheet.elk.sh/1mejGkcnF-f_qE4kw47FABEIkv8SZ4QgXAlciUOURYMo/Watch";

        var state = "M"; // multiple list

        function _onload() {
            document.getElementById("reloadbutton").addEventListener("click", () => loadList());

            document.getElementById("toggolbutton").addEventListener("click", (e) => {
                toggle();
            });

            document.getElementById("filter").addEventListener("change", (e) => {
                var opt = e.target.value;
                var sections = document.getElementsByClassName("w-section");
                console.log(sections);
                Array.from(sections).map((s) => { s.id == opt || opt == "-" ? s.style.display = "block" : s.style.display = "none" });
            });

            // initialization
            var s = localStorage.getItem("state");
            if (s) { state = s }
            updateState();
            loadList();
        }

        function loadList() {
            state == "M" ? loadWidget(loadMultipleList) : loadWidget(loadSingleList);
        }

        function toggle() {
            state == "M" ? state = "S" : state = "M";

            updateState();
            loadList();
        }

        function updateState() {
            console.log("current state", state);
            var filterControl = document.getElementById("filter");
            var label = "";
            if (state == "S") {
                label = "Multiple List";
                filterControl.style.display = "none";
            }
            else {
                label = "Single List";
                filterControl.style.display = "inline";
            }
            document.getElementById("toggolbutton").textContent = label;
            localStorage.setItem("state", state);
        }

        function clearELementById(id) {
            var container = document.getElementById(id);
            while (container.firstChild) {
                container.removeChild(container.lastChild);
            }
        }

        function fetchData(handler) {
            fetch(gs_watch_url)
                .then((res) => res.json())
                .then((data) => { handler(data) });
        }

        function loadWidget(handler) {
            clearELementById("container");
            fetchData(handler);
        }

        function loadSingleList(data) {
            console.log("single");
            var list = data.map(row => row.CGID);
            console.log(list);
            createWatchList(list);
        }

        function loadMultipleList(data) {
            console.log("mutiple");

            var result = data.reduce(function (map, obj) {

                var v = map[obj.Type];
                !v ? map[obj.Type] = [obj.CGID] : map[obj.Type].push(obj.CGID);
                return map;
            }, {});
            console.log(result);

            createFilterOption(Object.keys(result));

            Object.keys(result).map((key) => {
                createWatchList(result[key], key)
            });
        }

        function createFilterOption(types) {
            clearELementById("filter");
            var filterControl = document.getElementById("filter");
            var o = document.createElement("option");
            o.value = "-";
            o.text = "ALL";
            filterControl.appendChild(o);

            types.map((type) => {
                var o = document.createElement("option");
                o.value = o.text = type;
                filterControl.appendChild(o);
            })
        }

        function createWatchList(list, type) {
            var wrapper = document.createElement("div");
            wrapper.className = "col-sm w-section";
            if (type) wrapper.id = type;

            // example:
            //     <coingecko-coin-list-widget id="listwidget" coin-ids="bitcoin" currency="usd" locale="en">
            //     </coingecko-coin-list-widget>
            if (type) {
                var h = document.createElement("h4");
                h.textContent = type;
                console.log(h);
                wrapper.appendChild(h);
            }

            var w = document.createElement("coingecko-coin-list-widget");
            w.setAttribute("currency", "usd");
            w.setAttribute("locale", "en");
            w.setAttribute("coin-ids", list.join(","));

            wrapper.appendChild(w);

            var hole = document.getElementById("container");
            hole.appendChild(wrapper);

        }
    </script>
</head>

<body onload="_onload()">
    <header>
        <a href="index.html" class="logo"><img width="40" style="vertical-align: middle;" src="logo.png"></a>
        <a href="index.html" class="button">Home</a>
    </header>

    <h1>Watch List</h1>
    <button id="reloadbutton"><img width="20" style="vertical-align: middle;"
            src="https://img.icons8.com/external-becris-lineal-becris/64/000000/external-refresh-mintab-for-ios-becris-lineal-becris.png" />
        Reload</button>
    <button class="primary shadowed" id="toggolbutton">Single List</button>
    <select id="filter"></select>

    <div class="container">
        <div class="row" id="container"></div>
    </div>
</body>

</html>