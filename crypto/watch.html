<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/png" href="favicon.png">
    <title>Watch List - Oxlâ˜°yrd</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css">

    <script src="https://widgets.coingecko.com/coingecko-coin-list-widget.js"></script>
    <style>
        .w-hole {
            display: table-row
        }

        .w-title {
            /* font-size: larger; */
            font-style: bold;
            vertical-align: middle;
            height: 100%;
            padding-left: 20px;

        }

        .small-text {
            font-size: small;
            overflow-wrap: break-word
        }

        .active {
            background-color: #ddd;
        }

        .w-section {
            /* padding: 10px; */
            min-width: 300px;
            padding-bottom: 20px;
        }
    </style>
    <script>
        // https://benborgers.com/posts/google-sheets-json
        var gs_watch_url = "https://opensheet.elk.sh/1mejGkcnF-f_qE4kw47FABEIkv8SZ4QgXAlciUOURYMo/Watch";

        var state = "M"; // multiple list
        var filter = "-"; // all sections
        var autorefresh = 30; // default: 15 secs


        var timerId;
        // countdown timer
        var countdownTimer;
        var countdownValue = 0;


        function _onload() {
            // event listeners
            document.getElementById("reloadbutton").addEventListener("click", () => refreshData());
            document.getElementById("toggolbutton").addEventListener("click", () => toggle());
            document.getElementById("filter").addEventListener("change", (e) => { filter = e.target.value; changeFilter() });
            document.getElementById("autorefresh").addEventListener("change", (e) => { autorefresh = e.target.value; setupAutoRefresh() });
            // initialization
            loadSetting();
            init();
        }

        function loadSetting() {
            var s = localStorage.getItem("state");
            var f = localStorage.getItem("filter");
            var a = localStorage.getItem("autorefresh");

            console.log("init - state", s, "; filter", f, "autorefresh", a);

            if (s) { state = s }
            if (f) { filter = f; }
            if (a) { autorefresh = parseInt(a); }
        }

        function init() {
            updateState();

            loadList();

            setupAutoRefresh();
        }

        function setupAutoRefresh() {
            console.log("setupAutoRefresh");
            localStorage.setItem("autorefresh", autorefresh);

            // countdown
            abortCountdownTimer();
            countdownValue = autorefresh - 1;
            countdownTimer = setTimeout(countdown, 1000);

            // set timeout
            abortTimer();
            timerId = setTimeout(refreshData, autorefresh * 1000);
        }

        // auto refresh data
        function refreshData() {

            console.log("..... refresh data .....");
            loadList();
            // countdownValue = autorefresh;
            // abortTimer();
            // timerId = setTimeout(refreshData, autorefresh * 1000); // repeat myself

            setupAutoRefresh();
        }
        function abortTimer() { // to be called when you want to stop the timer
            if (timerId) {
                clearTimeout(timerId);
            }
        }

        function countdown() {
            var countdownCtl = document.getElementById("countdown");
            countdownCtl.textContent = countdownValue--;
            countdownTimer = setTimeout(countdown, 1000);
        }
        function abortCountdownTimer() {
            if (countdownTimer) {
                clearTimeout(countdownTimer);
            }
        }

        function changeFilter() {
            console.log("changeFilter, current filter", filter);
            localStorage.setItem("filter", filter);
            var sections = document.getElementsByClassName("w-section");
            Array.from(sections).map((sec) => {
                sec.id == filter || filter == "-" ? sec.style.display = "block" : sec.style.display = "none"
            });
        }

        function loadList() {
            console.log("loadList...");
            state == "M" ? loadWidget(loadMultipleList) : loadWidget(loadSingleList);
        }

        function toggle() {
            state == "M" ? state = "S" : state = "M";
            init();
        }

        function updateState() {
            console.log("current state", state);
            var autoRefreshInput = document.getElementById("autorefresh");
            var countdownCtl = document.getElementById("countdown");

            autoRefreshInput.value = autorefresh;
            countdownCtl.textContent = autorefresh;

            var filterControl = document.getElementById("filterctl");
            var label = "";
            if (state == "S") {
                label = "Multiple List";
                filterControl.style.display = "none";
            }
            else {
                label = "Single List";
                filterControl.style.display = "block";
            }
            document.getElementById("toggolbutton").textContent = label;
            localStorage.setItem("state", state);
        }

        function clearELementById(id) {
            var container = document.getElementById(id);
            while (container.firstChild) {
                container.removeChild(container.lastChild);
            }
        }

        function fetchData(handler) {
            fetch(gs_watch_url)
                .then((res) => res.json())
                .then((data) => { handler(data) });
        }

        function loadWidget(handler) {
            clearELementById("container");
            fetchData(handler);
        }

        function loadSingleList(data) {
            console.log("single");
            var list = data.map(row => row.CGID);
            createWatchList(list);
        }

        function loadMultipleList(data) {
            console.log("mutiple");

            var result = data.reduce(function (map, obj) {

                var v = map[obj.Type];
                !v ? map[obj.Type] = [obj.CGID] : map[obj.Type].push(obj.CGID);
                return map;
            }, {});

            // 1. create the watch list first
            Object.keys(result).map((key) => {
                createWatchList(result[key], key)
            });

            // 2. then create the filter
            createFilterOption(Object.keys(result));
        }

        function createFilterOption(types) {
            clearELementById("filter");
            var filterControl = document.getElementById("filter");
            var o = document.createElement("option");
            o.value = "-";
            o.text = "ALL";
            filterControl.appendChild(o);

            types.map((type) => {
                var o = document.createElement("option");
                o.value = o.text = type;
                filterControl.appendChild(o);
            })
            console.log("constructed filter", filterControl.value);
            if (filter != filterControl.value) {
                filterControl.value = filter;
                console.log("set new filter", filterControl.value);
                changeFilter();
            }
        }

        function createWatchList(list, type) {
            var wrapper = document.createElement("div");
            wrapper.className = "col-sm w-section";
            if (type) wrapper.id = type;

            // example:
            //     <coingecko-coin-list-widget id="listwidget" coin-ids="bitcoin" currency="usd" locale="en">
            //     </coingecko-coin-list-widget>
            if (type) {
                var h = document.createElement("h4");
                h.textContent = type;
                wrapper.appendChild(h);
            }

            var w = document.createElement("coingecko-coin-list-widget");
            w.setAttribute("currency", "usd");
            w.setAttribute("locale", "en");
            w.setAttribute("coin-ids", list.join(","));

            wrapper.appendChild(w);

            var hole = document.getElementById("container");
            hole.appendChild(wrapper);
        }


    </script>
</head>

<body onload="_onload()">
    <header>
        <a href="index.html" class="logo"><img width="40" style="vertical-align: middle;" src="logo.png"></a>
        <a href="index.html" class="button">Home</a>
        <button class="active">Watch List</button>
    </header>

    <div class="container">
        <div class="row">
            <div class="col-sm-12 col-md-8">
                <button class="primary shadowed" id="toggolbutton">Single List</button>
                <span class="small-text">Auto Refresh (s)</span>
                <input id="autorefresh" type="number" min="10" max="60">
                <button id="reloadbutton"><img width="15" style="vertical-align: middle;"
                        src="https://img.icons8.com/external-kmg-design-glyph-kmg-design/32/000000/external-refresh-arrow-kmg-design-glyph-kmg-design.png" />
                    Reload (<span id="countdown"></span>)
                </button>

            </div>

            <div class="col-sm-12 col-md-4">
                <div id="filterctl" style="float:right">
                    <label for="filter">Filter</label>
                    <select id="filter"></select>
                </div>
            </div>
        </div>
    </div>


    <div class="container">
        <div class="row" id="container"></div>
    </div>
</body>

</html>